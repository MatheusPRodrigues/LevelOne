@{
    ViewData["Title"] = "Atendimento Virtual";
}

<div class="container mt-4" style="max-width: 700px;">
    <h2 class="text-center mb-4 text-primary fw-semibold">Assistente Virtual</h2>

    <div id="chat" class="chat-box"></div>

    <div class="mt-3 d-flex">
        <input type="text" id="mensagem" class="form-control" placeholder="Digite sua mensagem..." />
        <button id="enviar" class="btn btn-primary ms-2">Enviar</button>
    </div>
</div>

<script>
    let interacoes = 0;

    document.getElementById("enviar").addEventListener("click", async () => {
        const msg = document.getElementById("mensagem").value;
        if (!msg.trim()) return;

        const chat = document.getElementById("chat");

        // Mensagem do usuário (lado direito)
        chat.innerHTML += `
            <div class="msg-user">
                <div class="msg-user-content">
                    <div class="msg-name">Você</div>
                    <div class="msg-user-text">${msg}</div>
                </div>
                <i class="bi bi-person-circle msg-user-icon"></i>
            </div>
        `;
        document.getElementById("mensagem").value = "";

        // Indicador de "digitando"
        const loading = document.createElement("div");
        loading.classList.add("typing-indicator");
        loading.innerHTML = `
            <i class="bi bi-robot"></i>
            <div class="dots"><span></span><span></span><span></span></div>
        `;
        chat.appendChild(loading);
        chat.scrollTop = chat.scrollHeight;

        // Aguarda resposta do backend
        const response = await fetch("/Chatbot/EnviarMensagem", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "mensagem=" + encodeURIComponent(msg)
        });

        const data = await response.json();

        // Remove animação de carregamento
        loading.remove();

        // Mensagem do bot
        chat.innerHTML += `
            <div class="msg-bot">
                <i class="bi bi-robot msg-bot-icon"></i>
                <div>
                    <div class="msg-name">Assistente Virtual</div>
                    <div class="msg-bot-text">${data.resposta}</div>
                </div>
            </div>
        `;

        chat.scrollTop = chat.scrollHeight;
        interacoes++;

        // Após 3 tentativas
        if (interacoes >= 3) {
            chat.innerHTML += `
                <div class="msg-bot">
                    <i class="bi bi-robot msg-bot-icon"></i>
                    <div>
                        <div class="msg-bot-text">
                            Parece que você ainda não conseguiu solucionar o problema.
                            <button class="btn btn-sm btn-success ms-2" onclick="window.location='@Url.Action("Create", "Chamados")'">
                                Abrir Chamado
                            </button>
                        </div>
                    </div>
                </div>
            `;
            interacoes = 0;
        }
    });
</script>
